# 프록시 서버

## 정의

- 클라이언트 입장에서 트랜젝션을 수행하는 중개인
- 클라이언트 ↔ 프록시 서버 ↔ 서버

## 특징

- 웹 서버이기도 하고 클라이언트이기도함
- HTTP 클라이언트 요청을 받게 되므로, 웹 서버처럼 요청과 커넥션을 다루고 응답해야함
- 양쪽 HTTP 어플규약을 잘 따라야함

### 공용 프록시

- 여러 클라이언트가 공유하는 프록시 서버
- 중앙 집중형 프록시를 관리하는게 더 비용효율이 높고 쉬움
  - 캐시 프록시 서버 같은 어플리케이션은 사용자가 많을수록 유리 → 공통된 요청에서 이득을 취하기 쉬움

### 개인 프록시

- 하나의 클라이언트만을 위한 프록시 서버
- 브라우저 서드 파티 툴같은 느낌

## 프록시 서버 vs 게이트웨이

- 프록시 서버
  - 같은 프로토콜을 이용하는 둘 이상의 어플리케이션 연결
- 게이트웨이
  - 서로 다른 프로토콜을 사용하는 둘 이상을 연결

## 프록시 서버를 사용 예시



## 프록시의 배치

| 프록시 서버 사용 이유        | 예시                       | 설명                                                         |
| ---------------------------- | -------------------------- | ------------------------------------------------------------ |
| 보안 개선                    | 문서 접근 제어             | 웹 리소스에 대한 단일한 접근 제어 전략을 구현                |
| 감사 추적 (대기업 환경)      | 보안 방화벽                | 조직 안에 들어오거나 나가는 응용 레벨 프로토콜의 흐름을 네트워크 지점에서 통제 |
|                              | 익명화                     | 사용자 개인정보 보호를 위한 메시지 변경                      |
| 성능 향상 / 비용 절약        | 웹 캐시                    | 인기 있는 문서의 로컬 사본을 관리하고 해당 문서에 대한 요청이 오면 빠르게 제공 (CDN) |
|                              | 리버스 프록시 (서로게이트) | 서버 앞단에서 요청을 받는 프록시 서버<br />요청 받은 콘텐츠의 위치를 찾아내기 위해 다른 서버와의 커뮤니케이션 |
| 트래픽 감시 및 수정 (필터링) | 유해 차단 필터             | 성인 콘텐츠 차단                                             |
|                              | 콘텐츠 라우터              | 인터넷 트래픽 조건과 종류에 따른 요청을 특정 웹 서버로 유도  |
|                              | 트랜스 코더                | 클라이언트에게 접근하기 전에 본문 포맷을 수정                |



### 출구 프록시

- 로컬 네트워크 출구에 위치
- 필터링 프록시를 위해 주로 사용

### ISP 프록시 (접근(입구)프록시)

- [ISP(Internet Service Provider)](https://ko.wikipedia.org/wiki/인터넷_서비스_제공자) 접근 지점에 위치
- 성능 개선 및 캐시 이용

### 리버스 프록시

- 웹 서버 바로 앞에 위치
- 필요할 때만 웹 서버에게 자원 요청
- 보안 기능을 추가하거나 빠른 웹 서버 캐시를 느린 웹 서버 앞에 놓아 성능 개선

### 네트워크 교환 프록시

- 트래픽 감시와 인터넷 혼잡 완화
- 네트 워크 사이의 인터넷 피어링 교환 지점에 놓음

## 프록시의 계층

- 프록시 계층에서 원 서버에 도달하기 까지의 순서로 구성된 것
- 서버에 가까운 프록시 : 인바운드 프록시 (부모)
- 클라이언트에 가까운 프록시 : 아웃바운드 프록시 (자식)

### 콘텐츠 라우팅

- 프록시 계층은 정적이지만, 특정 기준에 따라 다양하게 부모를 선택할 수 있음

**동적 부모 선택의 기준**

- 부하 균형
  - 부모들의 작업량 수준에 근거하여 유동적으로 부모를 선택
- 지리적 인접성에 근거한 라우팅
  - 원 서버의 지역을 담당할 수 있는 부모를 선택하여 라우팅
- 프로토콜/타입 라우팅
  - URI에 근거하여 다른 부모나 원 서버로 라우팅
- 유료 서비스 가입자를 위한 라우팅
  - 빠른 서비스를 위해 추가금을 지불 했을 때 더 나은 성능으로 라우팅

## 프록시가 트래픽을 처리하는 방법

- 클라이언트 트래픽이 프록시로 가도록 만드는 방법

### 클라이언트 수정

- 브라우저에서 프록시 서버를 보게 설정

### 네트워크 수정 (인터셉트 프록시/투명 프록시)

- 스위칭, 라우팅 장치로 트래픽을 가로채는 방법
  - 기업 공간 내에서의 보안 감시
  - 공용 와이파이

### DNS 이름 공간을 수정

- 웹 서버의 이름과 IP 주소를 대신 사용하는 프록시로 수정

### 웹 서버를 수정

- 프록시에서 리다이렉트 하는 서버로 반환

## 클라이언트 프록시 설정

- 모든 브라우저는 프록시를 사용할 수 있도록 설정할 수 있음


### 수동 설정

- 프록시를 사용하겠다고 명시적 설정

### 브라우저 기본 설정

- 브라우저 벤더나 배포자가 소비자에게 전달하기 전에 프록시를 미리 설정

### 프록시 자동 설정(Proxy auto-configuration, PAC)

- 자바스크립트 프록시 설정 파일에 대한 URI 제공
- 모든 콘텐츠를 위해 단 하나의 프록시를 지정할 수 밖에 없고, 장애 대응이 어려움 → 동적 해결책
- .pac 확장자
- FindProxyForUrl 함수 정의 ([예제](https://www.cisco.com/c/ko_kr/support/docs/security/web-security-appliance/118076-configure-wsa-00.html))

```jsx
function FindProxyForURL(url, host) {
  // ...
}
```

| FindProxyForURL 반환값 | 설명                                 |
| ---------------------- | ------------------------------------ |
| DIRECT                 | 프록시 없이 연결이 직접 이루어져야함 |
| PROXY host:post        | 지정한 프록시를 사용해야함           |
| SOCKS host:post        | 지정한 SOCKS 서버를 사용해야함       |

### WPAD (Autodiscovery Protocol) 프록시 발견

- 대부분의 브라우저는 자동 설정 파일을 받을 수 있는 웹 프록시 자동 발견 프로토콜을 제공

1. 동적 호스트 발견 규약
2. 서비스 위치 규약
3. DNS 잘 알려진 호스트 명
4. DNS SRV
5. DNS TXT 레코드 안 서비스 URI

## 프록시 요청의 미묘한 특징들

### 프록시 URI는 서버 URI와 다름

- 클라이언트가 프록시를 사용하지 않도록 설정되어 있다면, 스킴, 호스트, 포트 번호가 없는 부분 URI를 가짐

```jsx
GET /index.html HTTP/1.0
User-Agent: SuperBrowser v1.3
```

- 부분 URI의 문제가 부상되면서 서버의 목적지를 알아야함 → 서버의 이름을 알아야함
- 클라이언트가 프록시를 사용하도록 설정되어 있다면, 완전한 URI를 보냄

```jsx
GET [<http://www.marys-antiques.com/index.html>](<http://www.marys-antiques.com/index.html>) HTTP/1.0
User-Agent: SuperBrowser v1.3
```

### 가상 호스팅에서 일어나는 같은 문제

- 명시적인 프록시는 요청 메시지가 완전한 URI를 갖도록 함으로써 해결
- 가상으로 호스팅 되는 웹 서버는 호스트와 포트에 대한 정보가 담겨있는 Host 헤더 요구

### 프록시는 프록시 요청과 서버 요청을 모두 다룰 수 있음

- 명시적인 프록시 요청에 대해선 완전한 URI 사용

- 완전 URI가 주어졌다면, 프록시는 그것을 사용해야 함

- 부분 URI가 주어졌고 `Host 헤더`가 있다면, Host 헤더를 이용해 원 서버의 `이름`과 `포트번호`를 알아내야 함

- 부분 URI가 주어졌으나 

  ```
  Host 헤더
  ```

  가 없다면, 다음의 방법으로 원 서버를 알아내야 함

  - 프록시가 `대리 프록시`라면, 프록시에 실제 서버의 `IP 주소`와 `포트번호`가 설정되어 있을 수 있음
  - 이전에 어떤 `인터셉트 프록시`가 가로챘던 트래픽을 받았고, 그 인터셉트 프록시가 `IP 주소`와 `포트번호`를 사용할 수 있도록 해두었다면, 그 IP 주소와 포트번호를 사용할 수 있음
  - 모두 실패했다면, 프록시는 원 서버를 알아낼 수 있는 충분한 정보를 갖고 있지 못한 것이므로 반드시 **에러 메시지**를 반환

### 전송중 URI 변경

- 사소한 URI 변경이라도 다운스트림 서버와 상호운용성 문제를 일으킬 수 있다.
- 유일한 예외 : 빈 경로를 `/` 로 교체

## **메시지 추적**

프록시가 점점 흔해지면서, 서로 다른 스위치와 라우터를 넘나드는 IP 패킷의 흐름을 추적하는 것 못지않게 프록시를 넘나드는 메시지의 흐름을 추적하고 문제점을 찾아내는 것도 중요해짐

### **Via 헤더**

- Via 헤더 필드는 메시지가 지나는 각 중간 노드의 정보를 나열함. 메시지가 또 다른 노드를 지날 때마다, 중간 노드는 Via 목록의 끝에 추가됨.
- Via 문법
  - 쉼표로 경유지 목록을 구분함
  - 각 경유지는 개별 프록시 서버나 게이트웨이 홈을 나타냄
  - 중간 노드의 프로토콜과 주소에 대한 정보가 담김
- 헤더 형식 구문

```jsx
Via = "Via" ":" 1#( waypoint )
waypoint = ( received-protocol received-by [ comment ] )
received-protocol = [ protocol-name "/" ] protocol-version
received-by = ( host [ ":" port ] ) | pseudonym
```

- 프로토콜 이름: 중개자가 받은 프로토콜
- 프로토콜 버전: 수신한 메시지의 버전
- 노드 이름: 중개자의 호스트와 포트 번호
- 노드 코멘트: 중개자 노드를 서술하는 선택적인 코멘트
- Via 요청과 응답 경로: 요청 메시지와 응답 메시지 모두 프록시를 지나므로 둘 다 Via 헤더를 가짐
- Via와 게이트웨이
- Server 헤더와 Via 헤더
- Via가 개인정보 보호와 보안에 미치는 영향

### **6.6.2 TRACE 메서드**

프록시 서버는 메시지가 전달될 때 메시지를 바꿀 수 있음(헤더가 추가되거나, 변경되거나, 삭제될 수 있으며, 본문이 다른 형식으로 변환될 수 있음). 변경 방식은 벤더마다 다른데, 이를 추적하기 위한 방법으로 TRACE 메서드를 사용함

HTTP/1.1의 **TRACE 메서드**는 요청 메시지를 프록시의 연쇄를 따라가면서 어떤 프록시를 지나가고 프록시가 요청 메시지를 수정하는지 관찰/추적할 수 있게 해줌 --> 프록시 흐름을 디버깅하는 데 유용함

TRACE 요청이 목적지 서버에 도착했을 때, 서버는 전체 요청 메시지를 HTTP 응답 메시지의 본문에 포함해 송신자에게 그대로 돌려보냄

## 프록**시 인증**

프록시는 접근 제어 장치로도 사용됨. HTTP는 사용자가 유효한 접근 권한 자격을 프록시에 제출하지 않는 한 콘텐츠에 대한 요청을 차단하는 프록시 인증이라는 메커니즘을 정의함

## 프록**시 상호운용성**

클라이언트, 서버, 벤더마다 HTTP 명세를 다르게 구현할 수 있음

### **지원하지 않는 헤더와 메서드 다루기**

넘어오는 헤더 필드를 이해하지 못할 때 그대로 전달함

### **OPTIONS: 어떤 기능을 지원하는지 알아보기**

HTTP OPTIONS 메서드는 서버나 웹 서버의 특정 리소스가 어떤 기능을 지원하는지 클라이언트(혹은 프록시)가 알아볼 수 있게 함

### **Allow 헤더**

- Allow 엔터티 헤더 필드는 요청 URI에 의해 식별되는 자원에 대해 지원되는 메서드들이나 서버가 지원하는 모든 메서드를 열거함
- Allow 헤더는 새 리소스가 지원했으면 하는 메서드를 추천하기 위해 요청 헤더로 사용될 수 있음